<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ateneo Clínico IA - Debate Médico Profesional</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-primary: #10B981; /* Esmeralda */
            --color-secondary: #0D9488; /* Teal */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .btn-primary { 
            background-color: var(--color-primary); 
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .btn-primary:hover { 
            background-color: var(--color-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-shadow { box-shadow: 0 10px 25px rgba(16, 185, 129, 0.15); }
        .loading-ring { 
            border: 4px solid rgba(255, 255, 255, 0.2); 
            border-top: 4px solid white; 
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
            display: none; /* Por defecto oculto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center items-start">

        <div id="app-container" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 card-shadow">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 flex items-center justify-center">
                <i class="fas fa-brain text-4xl text-emerald-500 mr-3"></i> Ateneo Clínico <span class="text-emerald-500">IA</span>
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Plataforma de Debate Médico impulsada por May Roga LLC Vida y Felicidad.</p>
            <div id="debug-info" class="text-xs mt-2 text-red-500"></div>
        </header>

                <div id="content-view">
                    </div>

    </div>

        <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-md shadow-xl">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4"></h3>
            <p id="modal-body" class="text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="w-full btn-primary text-white py-2 font-semibold">Entendido</button>
        </div>
    </div>


    <script>
        // ***************************************************
        // CONFIGURACIÓN Y UTILIDADES GLOBALES
        // ***************************************************

        // REEMPLAZAR esta URL con la URL REAL de tu backend de Render
        const API_BASE_URL = "http://localhost:8000"; // <-- ¡IMPORTANTE! Cambiar esto al desplegar.
        const $ = (id) => document.getElementById(id);
        
        let currentView = 'waiver';
        let userEmail = '';
        let userType = '';
        
        const views = {}; // Objeto para almacenar las funciones de renderizado de vistas
        
        // Función para mostrar el modal de mensajes (Reemplaza alert())
        function showModal(title, body, nextAction = null) {
            $('modal-title').innerText = title;
            $('modal-body').innerText = body;
            $('message-modal').classList.remove('hidden');
            
            const closeButton = document.querySelector('#message-modal button');
            closeButton.onclick = () => {
                closeModal();
                if (nextAction) nextAction();
            };
        }

        function closeModal() {
            $('message-modal').classList.add('hidden');
            const closeButton = document.querySelector('#message-modal button');
            closeButton.onclick = closeModal; // Restaurar la función por defecto
        }

        /**
         * Función utilitaria para copiar texto de un elemento al portapapeles.
         * @param {string} elementId - ID del elemento (generalmente un textarea o input) cuyo texto se copiará.
         */
        function copyToClipboard(elementId) {
            const copyText = $(elementId);
            if (!copyText) return showModal('Error', 'Elemento de texto no encontrado.');

            copyText.select();
            copyText.setSelectionRange(0, 99999); // Para móviles

            try {
                // Usamos document.execCommand('copy') por restricciones de iFrame
                document.execCommand('copy');
                showModal('¡Copiado!', 'El mensaje viral ha sido copiado a tu portapapeles.');
            } catch (err) {
                showModal('Error al Copiar', 'No se pudo copiar el texto. Por favor, cópielo manualmente.');
                console.error('Error al intentar copiar al portapapeles:', err);
            }
        }

        // Función para mostrar/ocultar loaders en botones
        function toggleLoading(formId, isLoading) {
            const form = $(formId);
            if (!form) return;
            const button = form.querySelector('button[type="submit"]');
            const loader = button ? button.querySelector('.loading-ring') : null;

            if (button && loader) {
                if (isLoading) {
                    button.disabled = true;
                    loader.style.display = 'block';
                    button.classList.add('opacity-70', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    loader.style.display = 'none';
                    button.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }
        }

        // Función de fetch con manejo de errores
        async function apiFetch(endpoint, options = {}, formId = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            if (formId) toggleLoading(formId, true);

            try {
                const response = await fetch(url, options);
                
                if (formId) toggleLoading(formId, false);

                if (!response.ok) {
                    const errorData = await response.json();
                    showModal('Error en la Solicitud', errorData.detail || `Error de red o servidor: ${response.status}`);
                    return null;
                }
                
                // Manejar respuesta vacía (ej: 204 No Content)
                if (response.status === 204) return {};
                
                return await response.json();
            } catch (error) {
                if (formId) toggleLoading(formId, false);
                showModal('Error de Conexión', `No se pudo conectar al backend: ${error.message}. Asegúrate de que el servidor está corriendo en ${API_BASE_URL}`);
                console.error("Fetch Error:", error);
                return null;
            }
        }

        // ***************************************************
        // LÓGICA DE VISTAS Y NAVEGACIÓN
        // ***************************************************

        function navigateTo(viewName) {
            currentView = viewName;
            render();
        }

        function render() {
            const viewFn = views[currentView];
            if (viewFn) {
                $('content-view').innerHTML = viewFn();
                // Llamar a la función onEnter de la vista si existe, después de que el HTML esté en el DOM
                if (viewFn.onEnter) {
                    viewFn.onEnter();
                }
            } else {
                // Caso por defecto
                $('content-view').innerHTML = views.waiver();
            }
        }

        // --- VISTA 1: ACEPTACIÓN DE TÉRMINOS LEGALES ---
        views.waiver = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-3 mb-4">Acuerdo de Uso (Waiver)</h2>
                <div class="bg-red-50 border border-red-200 p-4 rounded-lg text-sm text-red-700 space-y-2">
                    <p class="font-bold flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> Advertencia Legal Obligatoria</p>
                    <p>Al continuar, usted acepta que esta plataforma es únicamente para fines **educativos, de simulación y de debate clínico**. Las decisiones y diagnósticos generados por la IA o los profesionales no constituyen asesoramiento médico real. La responsabilidad clínica final recae exclusivamente en el profesional de la salud humano.</p>
                </div>
                
                <form id="waiverForm" class="space-y-4">
                    <div>
                        <label for="waiverEmail" class="block text-sm font-medium text-gray-700">Tu Correo Electrónico:</label>
                        <input type="email" id="waiverEmail" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <div>
                        <label for="userType" class="block text-sm font-medium text-gray-700">Tipo de Usuario:</label>
                        <select id="userType" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="" disabled selected>Selecciona tu rol...</option>
                            <option value="volunteer">Voluntario (Quiero subir mi caso)</option>
                            <option value="professional">Profesional de la Salud (Quiero debatir)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary text-white py-3 font-bold flex items-center justify-center">
                        Aceptar Términos y Continuar 
                        <div class="loading-ring ml-3"></div>
                    </button>
                </form>
            </div>
        `;

        // ***************************************************
        // MANEJADORES DE SUBMIT (Waiver, Voluntario, Profesional)
        // ***************************************************

        document.addEventListener('submit', async (e) => {
            // 1. Submisión del Waiver
            if (e.target.id === 'waiverForm') {
                e.preventDefault();
                
                const email = $('waiverEmail').value.trim();
                const type = $('userType').value;
                
                if (!email || !type) {
                    showModal('Campos Incompletos', 'Por favor, introduce tu email y selecciona un tipo de usuario.');
                    return;
                }
                
                const data = await apiFetch('/waiver/accept', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, user_type: type })
                }, 'waiverForm');

                if (data) {
                    userEmail = email;
                    userType = type;
                    const nextView = userType === 'volunteer' ? 'volunteer_flow' : 'professional_flow';
                    showModal('¡Waiver Aceptado!', `Hemos registrado tu aceptación. Revisa tu correo (${email}) para el acuerdo legal. Ahora serás redirigido al flujo de ${userType === 'volunteer' ? 'Voluntario' : 'Profesional'}.`, () => navigateTo(nextView));
                }
            }

            // 2. Submisión del Caso (Voluntario)
            if (e.target.id === 'submitCaseForm' && paymentCompleted) {
                e.preventDefault();
                
                const historyText = $('historyText').value.trim();
                const imageFile = $('imageFile').files[0];
                
                if (!imageFile || !historyText) {
                    showModal('Campos Incompletos', 'Por favor, asegúrate de llenar el texto de la historia clínica y subir una imagen.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('image_file', imageFile);

                // IMPORTANTE: Los datos no-file se pasan en los headers aquí.
                const data = await apiFetch('/api/v1/volunteer/submit-case', {
                    method: 'POST',
                    headers: { 'Email': userEmail, 'History-Text': historyText },
                    body: formData 
                }, 'submitCaseForm');

                if (data) {
                    showModal('Tesis Generada', `Tu Tesis Clínica ha sido generada exitosamente. ID del Caso: ${data.case_id}. Serás redirigido al reporte.`, () => navigateTo('volunteer_report_view'));
                }
            }

            // 3. Registro del Profesional
            if (e.target.id === 'profRegisterForm') {
                e.preventDefault();
                
                const name = $('profName').value;
                const specialty = $('profSpecialty').value;
                
                const data = await apiFetch('/api/v1/professional/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, name: name, specialty: specialty })
                }, 'profRegisterForm');

                if (data) {
                    showModal('Registro Exitoso', `¡Bienvenido, Dr/a ${name}! Has recibido un crédito de bienvenida. Tienes ${data.profile.credits} créditos.`, () => {
                        $('profRegisterSection').classList.add('hidden');
                        $('profDebateSection').classList.remove('hidden');
                        updateProfCredits(data.profile.credits, data.profile.score_refutation);
                    });
                }
            }

            // 4. Generación de Caso (Profesional) - NUEVO
            if (e.target.id === 'generateCaseForm') {
                e.preventDefault();
                
                const especialidad = $('genEspecialidad').value;
                const complejidad = $('genComplejidad').value;
                const enfoque = $('genEnfoque').value.trim();

                await getNewCase(especialidad, complejidad, enfoque);
            }
        });


        // --- VISTA 2: FLUJO VOLUNTARIO (SUBIR CASO/PAGO) ---
        views.volunteer_flow = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-emerald-600 border-b pb-3 mb-4">Voluntario: Generar Tesis Clínica</h2>
                <p class="text-gray-700">¡Gracias por participar! Al subir tu caso (anónimo), pagas una **cuota única** para que la IA genere tu Tesis Clínica y para que miles de profesionales debatan tu diagnóstico.</p>

                <div id="paymentSection" class="bg-green-50 border-l-4 border-emerald-500 p-4 rounded-lg">
                    <p class="font-bold text-emerald-700">1. Paso de Pago</p>
                    <p class="text-sm text-gray-600 mt-1">Simulación de pago único: $50.00 USD (Esta cuota cubre el procesamiento de la IA).</p>
                    <button onclick="simulatePayment('volunteer')" id="payButton" class="mt-3 btn-primary text-white py-2 px-4 font-semibold text-sm flex items-center justify-center">
                        Pagar $50.00 USD y Subir Caso
                    </button>
                </div>

                <div id="submissionSection" class="hidden">
                    <p class="font-bold text-emerald-700 mb-4">2. Subir Historia Clínica (Anónima)</p>
                    <form id="submitCaseForm" class="space-y-4">
                        <div>
                            <label for="historyText" class="block text-sm font-medium text-gray-700">Historia Clínica (Texto):</label>
                            <textarea id="historyText" rows="6" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Ej: Paciente masculino de 65 años, con disnea progresiva de 3 meses..."></textarea>
                        </div>
                        <div>
                            <label for="imageFile" class="block text-sm font-medium text-gray-700">Imagen de Apoyo (Rayos X, ECG, etc.):</label>
                            <input type="file" id="imageFile" accept="image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                        </div>
                        <button type="submit" class="w-full btn-primary text-white py-3 font-bold flex items-center justify-center">
                            Generar Tesis Clínica con IA
                            <div class="loading-ring ml-3"></div>
                        </button>
                    </form>
                </div>
            </div>
        `;

        let paymentCompleted = false; // Simulación de estado de pago

        function simulatePayment(type) {
            // En una app real, aquí llamarías a Stripe y el webhook
            paymentCompleted = true;
            $('paymentSection').classList.add('hidden');
            $('submissionSection').classList.remove('hidden');
            showModal('Pago Exitoso (Simulado)', `¡Pago de $50.00 USD confirmado! Ya puedes subir tu caso y generar tu Tesis Clínica.`);
        }

        // --- VISTA 3: REPORTE VOLUNTARIO ---
        views.volunteer_report_view = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-emerald-600 border-b pb-3 mb-4">Reporte de Tesis Clínica</h2>
                <div id="reportContent" class="space-y-4">
                    <p class="text-gray-500 flex items-center font-semibold"><i class="fas fa-spinner fa-spin mr-2"></i> Cargando tu Tesis Clínica...</p>
                </div>
            </div>
        `;

        views.volunteer_report_view.onEnter = async () => {
            const data = await apiFetch(`/api/v1/volunteer/report/${userEmail}`, {
                method: 'GET'
            });

            const reportContainer = $('reportContent');

            if (data && data.report) {
                const report = data.report;
                const viralMessage = data.social_message;

                reportContainer.innerHTML = `
                    <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-md space-y-4">
                        <h3 class="text-xl font-bold text-emerald-700">Tesis de la IA (Caso ID: ${report.case_id})</h3>
                        <p class="text-sm font-semibold text-red-600">${data.warning}</p>
                        
                        <div class="border-t pt-4">
                            <p class="font-bold">Motivo de Consulta:</p>
                            <p class="text-gray-700">${report.chief_complaint}</p>
                        </div>

                        <div>
                            <p class="font-bold">Hipótesis Principal de la IA:</p>
                            <p class="text-lg font-bold text-blue-600">${report.ai_hypothesis}</p>
                        </div>
                        
                        <div>
                            <p class="font-bold">Diagnósticos Diferenciales:</p>
                            <ul class="list-disc list-inside text-gray-700 ml-4">
                                ${report.differential_diagnoses.map(d => `<li>${d}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-bold">Plan Diagnóstico Sugerido:</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${report.diagnostic_plan}</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-emerald-50 border border-emerald-200 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-emerald-700 mb-3 flex items-center"><i class="fas fa-share-alt mr-2"></i> Mensaje Viral para Redes</h3>
                        <p class="text-gray-700 mb-4">Copia este mensaje y compártelo para invitar a la comunidad médica a debatir tu caso.</p>
                        
                        <textarea id="viralMessageTextarea" readonly class="w-full h-24 border border-gray-300 p-3 rounded-lg bg-white text-sm whitespace-pre-wrap">${viralMessage}</textarea>
                        
                        <button onclick="copyToClipboard('viralMessageTextarea')" class="mt-3 w-full btn-primary text-white py-2 font-semibold text-sm">
                            <i class="fas fa-copy mr-2"></i> Copiar Mensaje Viral
                        </button>
                    </div>
                    <button onclick="navigateTo('waiver')" class="mt-6 text-gray-500 hover:text-gray-700 text-sm flex items-center">
                        <i class="fas fa-arrow-left mr-1"></i> Volver a Inicio
                    </button>
                `;
            } else {
                reportContainer.innerHTML = `<p class="text-red-600">No se pudo cargar el reporte. El caso puede estar aún en procesamiento o no existe.</p>
                <button onclick="navigateTo('volunteer_flow')" class="mt-4 btn-primary text-white py-2 px-4 font-semibold text-sm">
                    Volver a Subir Caso
                </button>`;
            }
        };

        // --- VISTA 4: FLUJO PROFESIONAL (REGISTRO/DEBATE) ---
        views.professional_flow = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-blue-600 border-b pb-3 mb-4">Profesional: Iniciar Debate</h2>
                <div id="profRegisterSection">
                    <p class="text-gray-700">Por favor, completa tu registro para acceder a los casos y un crédito de bienvenida.</p>
                    <form id="profRegisterForm" class="mt-4 space-y-4">
                        <div>
                            <label for="profName" class="block text-sm font-medium text-gray-700">Nombre Completo:</label>
                            <input type="text" id="profName" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="profSpecialty" class="block text-sm font-medium text-gray-700">Especialidad Médica:</label>
                            <input type="text" id="profSpecialty" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center">
                            Completar Registro y Recibir Crédito
                            <div class="loading-ring ml-3"></div>
                        </button>
                    </form>
                </div>
                
                <div id="profDebateSection" class="hidden space-y-4">
                    <p id="profCredits" class="text-lg font-bold text-gray-800"></p>
                    
                                        <form id="generateCaseForm" class="p-4 bg-gray-100 rounded-lg space-y-3 border border-gray-200">
                        <h4 class="font-bold text-gray-800">Definir Parámetros del Desafío (Generación IA):</h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <label for="genEspecialidad" class="block text-sm font-medium text-gray-700">Especialidad:</label>
                                <select id="genEspecialidad" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Pediatría" selected>Pediatría</option>
                                    <option value="Cardiología">Cardiología</option>
                                    <option value="Neurología">Neurología</option>
                                    <option value="Medicina Interna">Medicina Interna</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="genComplejidad" class="block text-sm font-medium text-gray-700">Nivel:</label>
                                <select id="genComplejidad" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Residente" selected>Residente</option>
                                    <option value="Especialista">Especialista</option>
                                    <option value="Experto">Experto</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="genEnfoque" class="block text-sm font-medium text-gray-700">Enfoque Clínico (Ej: Fiebre prolongada, Arritmia, Cefalea atípica):</label>
                            <input type="text" id="genEnfoque" value="fiebre prolongada" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <button type="submit" id="getCaseButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center">
                            <i class="fas fa-microscope mr-2"></i> Usar 1 Crédito y Generar Caso
                            <div class="loading-ring ml-3"></div>
                        </button>
                    </form>
                                        
                    <div id="activeCase" class="mt-6"></div>
                    <div id="submitDebateFormContainer" class="hidden"></div>
                </div>

                <div class="flex justify-between mt-4">
                    <button onclick="navigateTo('waiver')" class="text-sm text-gray-500 hover:text-gray-700 font-semibold flex items-center">
                        <i class="fas fa-arrow-left mr-1"></i> Volver a Inicio
                    </button>
                    <button onclick="navigateTo('buy_credits_flow')" class="text-sm text-blue-500 hover:text-blue-700 font-semibold flex items-center">
                        <i class="fas fa-shopping-cart mr-1"></i> Comprar Más Créditos
                    </button>
                </div>
            </div>
        `;
        
        // Función auxiliar para simular la actualización del perfil (asumiendo éxito)
        function updateProfCredits(credits, score = 0) {
            const creditsElement = $('profCredits');
            if (creditsElement) {
                creditsElement.innerHTML = `Créditos Disponibles: <span class="text-emerald-600 font-extrabold">${credits}</span> | Refutation Score: <span class="text-blue-600 font-extrabold">${score}</span>`;
            }
        }

        views.professional_flow.onEnter = () => {
             // Simulamos que el registro está completo si el email existe
             // En una app real, se cargaría el perfil del usuario desde el backend.
             if (userEmail) {
                 // Aquí se haría una llamada para obtener el saldo real.
                 // Simulamos un saldo inicial
                 $('profRegisterSection').classList.add('hidden');
                 $('profDebateSection').classList.remove('hidden');
                 updateProfCredits(1, 0); // Asumiendo 1 crédito de bienvenida y 0 score inicial
             } else {
                 $('profRegisterSection').classList.remove('hidden');
                 $('profDebateSection').classList.add('hidden');
             }
        }

        // INICIO DE MODIFICACIÓN: Función getNewCase para enviar parámetros
        async function getNewCase(especialidad, complejidad, enfoque) {
            // Activar loader en el botón de obtener caso
            const formId = 'generateCaseForm';
            toggleLoading(formId, true); // Usa la función global para el formulario

            // Llamada al Backend: ENVIANDO LOS PARÁMETROS para la IA
            const data = await apiFetch('/api/v1/professional/get-case', {
                method: 'POST', // Cambiamos a POST para enviar el body JSON
                headers: { 
                    'Content-Type': 'application/json',
                    'Email': userEmail 
                },
                body: JSON.stringify({
                    especialidad: especialidad,
                    complejidad: complejidad,
                    enfoque: enfoque
                })
            }, formId);

            toggleLoading(formId, false);

            if (data && data.case) {
                const caseData = data.case;
                // Usamos el inicio del diagnóstico de la IA como ID simulado
                const caseId = caseData.diagnostico_ia_a_debatir.substring(0, 10).replace(/[^a-zA-Z0-9]/g, '');

                // RENDERIZADO DEL CASO (usando la estructura JSON de Gemini)
                const caseHtml = `
                    <div class="bg-blue-50 border border-blue-200 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 class="text-xl font-bold text-blue-700 flex items-center"><i class="fas fa-hourglass-half mr-2"></i> Debate Activo (ID Simulado: ${caseId})</h3>
                        <p class="text-sm text-red-600 font-semibold">TIEMPO LÍMITE: 72 horas para mantener tu crédito y ranking.</p>
                        
                        <div class="border-t pt-4 space-y-2">
                            <p class="font-bold text-lg text-indigo-700">Diagnóstico de la IA (A Debatir):</p>
                            <p class="text-xl font-extrabold text-indigo-600">${caseData.diagnostico_ia_a_debatir}</p>

                            <p class="font-bold mt-4">Historia Clínica:</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${caseData.historia_clinica}</p>
                            
                            <p class="font-bold mt-4">Puntos Clave de Debate:</p>
                            <ul class="list-disc list-inside text-gray-700 ml-4">
                                ${caseData.puntos_clave_debate.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            
                            <p class="font-bold mt-4">Plan de Tratamiento Sugerido (Solo para Debate):</p>
                            <p class="text-gray-600 italic">${caseData.plan_tratamiento_sugerido}</p>
                        </div>
                    </div>
                `;
                
                $('activeCase').innerHTML = caseHtml;
                renderDebateForm(caseId);
                // Actualizar UI de créditos
                updateProfCredits('1 Crédito Usado', '?');
            } else if (data && data.detail) {
                 showModal('Créditos Necesarios', data.detail);
               }
        }
        // FIN DE MODIFICACIÓN

        function renderDebateForm(caseId) {
            $('submitDebateFormContainer').classList.remove('hidden');
            $('submitDebateFormContainer').innerHTML = `
                <form id="submitDebateForm" class="mt-6 space-y-4 p-6 bg-gray-50 rounded-xl border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800">Tu Refutación y Diagnóstico Final</h4>
                    <div>
                        <label for="profDiagnosis" class="block text-sm font-medium text-gray-700">Diagnóstico Final del Profesional:</label>
                        <textarea id="profDiagnosis" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Neumonía Adquirida en la Comunidad (NAC) - Refutación: La IA no consideró..."></textarea>
                    </div>
                    <div>
                        <label for="outcome" class="block text-sm font-medium text-gray-700">Resultado del Debate:</label>
                        <select id="outcome" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Selecciona tu resultado...</option>
                            <option value="victory">Victoria (+10 Score: Mi diagnóstico/refutación fue superior)</option>
                            <option value="defeat">Derrota (-5 Score: La IA tenía razón)</option>
                            <option value="draw">Empate (0 Score: Diagnósticos paralelos válidos)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-800 hover:bg-blue-900 text-white py-3 rounded-lg font-bold flex items-center justify-center">
                        Enviar Refutación
                        <div class="loading-ring ml-3"></div>
                    </button>
                </form>
            `;
            
            document.getElementById('submitDebateForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const data = {
                    case_id: caseId,
                    professional_diagnosis: $('profDiagnosis').value,
                    outcome: $('outcome').value
                };

                const result = await apiFetch('/api/v1/professional/submit-debate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Email': userEmail },
                    body: JSON.stringify(data)
                }, 'submitDebateForm');

                if (result) {
                    showModal('Debate Finalizado', `¡Felicidades! Su **Refutation Score** es ahora ${result.new_score}. Comparta su éxito: "${result.viral_message}"`, () => {
                         $('activeCase').innerHTML = '';
                         $('submitDebateFormContainer').classList.add('hidden');
                         updateProfCredits('?', result.new_score); // Se podría llamar a un endpoint para actualizar los créditos si existiera
                    });
                }
            });
        }
        
        // --- VISTA 5: COMPRAR CRÉDITOS ---
        
        function renderCreditPack(credits, price, label, borderClass) {
            return `
                <div class="bg-white border-2 ${borderClass} rounded-xl p-6 text-center transition-all hover:shadow-xl cursor-pointer" onclick="simulateCreditPurchase(${credits}, ${price})">
                    <p class="text-xs font-bold upp
                        <p class="text-xl font-bold text-gray-800">${credits} Créditos</p>
                        <p class="text-3xl font-extrabold text-blue-600 my-2">$${price}.00</p>
                        <p class="text-sm text-gray-500">${label}</p>
                        <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold">Comprar</button>
                    </div>
                `;
            }
            
            views.buy_credits_flow = () => `
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-blue-600 border-b pb-3 mb-4">Comprar Créditos para Debates</h2>
                    <p class="text-gray-700">Cada crédito te permite generar un nuevo caso de debate impulsado por IA. Recibirás una factura detallada de May Roga LLC.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${renderCreditPack(1, 15, "Crédito Individual", "border-gray-300")}
                        ${renderCreditPack(5, 60, "Ahorra 20%", "border-emerald-500")}
                        ${renderCreditPack(10, 100, "Mejor Oferta (Ahorra 33%)", "border-red-500")}
                    </div>
                    
                    <button onclick="navigateTo('professional_flow')" class="mt-6 text-gray-500 hover:text-gray-700 text-sm flex items-center">
                        <i class="fas fa-arrow-left mr-1"></i> Volver al Panel de Debate
                    </button>
                </div>
            `;
            
            function simulateCreditPurchase(credits, price) {
                // Aquí iría la lógica de Stripe Checkout/API
                showModal('Compra Simulada', `Has simulado la compra de ${credits} créditos por $${price}.00 USD. En una aplicación real, serías redirigido a Stripe.`, () => {
                    navigateTo('professional_flow');
                });
            }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });
    </script>
</body>
</html>
